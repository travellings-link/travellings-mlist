<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>成员列表 | 开往</title>
    <link href="https://unpkg.zhimg.com/bootstrap@4.4.1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="/css/style.css">
    <style>
        .adminOnly {
            display: none;
        }
        
        @media (max-width: 768px) {
            .pcOnly {
                display: none;
            }
            #mainTitle {
                font-size: 20px;
                margin-top: 6px;
            }

            .table td, .table th {
                font-size: 14px; /* 缩小字体 */
                padding: .75rem 0px; /* 缩小间距 */
            }
        }

    </style>
</head>

<body>
    <div class="container mt-4 mb-4">
        <div class="main p-3">
            <div class="row">
                <div class="col-4">
                    <h3 id="mainTitle">成员列表</h3>
                </div>
                <div class="col-8">
                    <input type="text" class="form-control" placeholder="键入 名称/链接/ID 以搜索..." id="searchInp">
                </div>
            </div>
            <div class="mt-3">
                <a class="btn btn-primary mb-1" href="https://www.travellings.cn/docs/join" target="_blank"><i class="fa fa-user-plus"></i> 申请加入</a>
                <a class="btn btn-secondary mb-1" href="https://www.travellings.cn/"><i class="fa fa-home"></i> 返回官网</a>
                <a class="btn btn-secondary mb-1" href="https://www.travellings.cn/go.html" target="_blank"><i class="fa fa-subway"></i> 开往</a>
                <button class="btn btn-secondary mb-1" id="refreshBtn"><i class="fa fa-refresh"></i> 刷新数据
                    <span class="spinner-border spinner-border-sm" style="display: none;" id="refreshSpinner"></span>
                </button>
                <select class="btn btn-info mb-1" id="statusFilter" data-toggle="tooltip" title="筛选指定状态的网站，搜索结果也会被筛选">
                    <option value="ALL">全部站点</option>
                    <option value="RUN">RUN</option>
                    <option value="OTHER">非 RUN</option>
                    <option value="LOST">LOST</option>
                    <option value="ERROR">ERROR</option>
                    <option value="TIMEOUT">TIMEOUT</option>
                    <option value="4XX">4XX</option>
                    <option value="5XX">5XX</option>
                    <option value="WAIT">WAIT</option>
                </select>
                <select class="btn btn-info mb-1" id="tagFilter" data-toggle="tooltip" title="筛选指定标签的网站，搜索结果也会被筛选">
                    <option value="go">全部类型</option>
                    <option value="blog">博客</option>
                    <option value="normal">杂项</option>
                    <option value="coder">技术类</option>
                    <option value="site">网站分享类</option>
                    <option value="life">生活类</option>
                    <option value="hybrid">综合类</option>
                </select>
                <span class="adminOnly">
                    <a class="btn btn-success mb-1" href="./user/admin/add.html" target="_blank"><i class="fa fa-plus"></i> 新增网站</a>
                    <a class="btn btn-success mb-1" href="./user/admin/sync.html" target="_blank"><i class="fa fa-check-square-o"></i> 一键添加</a>
                    <a class="btn btn-light mb-1" data-toggle="tooltip" title="点击退出登录" href="javascript:;" onclick="logout()"><i class="fa fa-user"></i> <span class="username"></span> (管理员)</a>
                </span>
                <span class="guestUserOnly" style="display: none;">
                    <a class="btn btn-light mb-1" data-toggle="tooltip" title="点击退出登录" href="javascript:;" onclick="logout()"><i class="fa fa-user"></i> <span class="username"></span> (普通用户)</a>
                </span>
            </div>

            <table class="table mt-3">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>站点名称</th>
                        <th>站点链接</th>
                        <th class="pcOnly" data-toggle="tooltip" title="具体含义详见官网“疑难解答”，鼠标悬停可查看部分错误信息">状态</th> 
                        <th class="pcOnly">TAG</th> 
                        <th class="adminOnly">操作</th>
                    </tr>
                </thead>
                <tbody id="mlist">
                    <tr>
                        <td colspan="6" class="text-center">
                            <span class="spinner-border spinner-border-sm"></span>
                            加载中...
                        </td>
                    </tr>
                </tbody>
            </table>
            <div class="text-center page-nav"></div>
            <div class="text-center mt-3">
                <a href="https://beian.miit.gov.cn/" target="_blank">闽ICP备2023011626号-1</a> |
                <a target="_blank"
                    href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=35059102000048">闽公网安备35059102000048号</a> |
                Frontend by <a href="https://github.com/xuanzhi33">@xuanzhi33</a> |
                Backend by <a href="https://github.com/BLxcwg666">@BLxcwg666</a> |
                <a href="https://github.com/travellings-link/travellings-mlist" target="_blank"><i class="fa fa-github"></i> 源代码</a>
            </div>
        </div>
    </div>

    <div class="modal fade" id="editItem">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content main">
    
            <!-- 模态框头部 -->
            <div class="modal-header">
              <h4 class="modal-title">编辑网站 <span class="badge badge-secondary">ID: <span id="siteID">0</span></span></h4>
              <button type="button" class="close" data-dismiss="modal">×</button>
            </div>
    
            <!-- 模态框主体 -->
            <div class="modal-body">
                <div class="alert alert-primary" style="display: none;" id="info"></div>
                <div class="mt-3">
                    <label for="websiteName">网站名称:</label>
                    <input type="text" class="form-control mb-3" id="websiteName" placeholder="请输入网站名称">
                    <label for="websiteLink">网站链接:</label>
                    <input type="url" class="form-control mb-3" id="websiteLink" placeholder="请输入网站链接">
                    <div class="row">
                        <div class="col-6">
                            <label for="status">网站状态:</label>
                            <select class="form-control mb-3" id="status">
                                <option value="RUN">正常 (RUN)</option>
                                <option value="LOST">网址存活，但无开往徽标 (LOST)</option>
                                <option value="ERROR">网址异常 (ERROR)</option>
                                <option value="TIMEOUT">连接超时 (TIMEOUT)</option>
                                <option value="WAIT">等待处理 (WAIT)</option>
                                <option value="400">400 Bad Request</option>
                                <option value="403">403 Forbidden</option>
                                <option value="404">404 Not Found</option>
                                <option value="405">405 Method Not Allowed</option>
                                <option value="418">418 I'm a teapot</option>
                                <option value="429">429 Too Many Requests</option>
                                <option value="500">500 Internal Server Error</option>
                                <option value="501">501 Not Implemented</option>
                                <option value="502">502 Bad Gateway</option>
                                <option value="503">503 Service Unavailable</option>
                                <option value="504">504 Gateway Timeout</option>
                            </select>
                        </div>
                        <div class="col-6">
                            <label for="tag">TAG:</label>
                            <input type="text" class="form-control mb-3" id="tag" placeholder="请输入TAG" value="go">
                        </div>
                    </div>
                </div>
            </div>
            <!-- 模态框底部 -->
            <div class="modal-footer">
              <button id="submitBtn" class="btn btn-primary"><span class="spinner-border spinner-border-sm" style="display: none;" id="spinner"></span>
                更新</button>
              <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
            </div>
          </div>
        </div>
      </div>

    <script src="https://unpkg.zhimg.com/jquery@3/dist/jquery.min.js"></script>
    <script src="https://cdn.staticfile.org/popper.js/1.16.1/umd/popper.min.js"></script>	
	<script src="https://unpkg.zhimg.com/bootstrap@4.4.1/dist/js/bootstrap.min.js"></script>
    <script>
        let listData = null;
        let userRole = "访客";
        let statusFilter = "ALL";
        let tagFilter = "go";
        let curPage = 1;
        let curData = null;
        let pageNum = 0;

        const pageSize = 20;

        let filterCurPage = data => {
            updatePageNav(data.length);
            let start = (curPage - 1) * pageSize;
            let end = start + pageSize;
            return data.slice(start, end);
        }

        let updatePageNav = total => {
            let pageBtn = (i) => {
                if (i == 0) {
                    return `<button class="btn btn-light" disabled>...</button>`;
                } else if (curPage == i) {
                    return `<button class="btn btn-primary">${i}</button>`;
                } else {
                    return `<button class="btn btn-light" onclick="gotoPage(${i})">${i}</button>`;
                }
            }

            pageNum = Math.ceil(total / pageSize);
            let pageNav = $('.page-nav');

            if (pageNum <= 1) {
                pageNav.html(''); // 清空
                return;
            }

            let html = `<div class="btn-group">`;

            html += pageBtn(1); // 首页

            let startPage = Math.max(2, curPage - 2);
            let endPage = Math.min(pageNum - 1, curPage + 2);

            if (startPage > 2) html += pageBtn(0);

            for (let i = startPage; i <= endPage; i++) {
                html += pageBtn(i);
            }

            if (endPage < pageNum - 1) html += pageBtn(0);
            
            html += pageBtn(pageNum); // 尾页

            html += `</div><br>
            <div class="btn-group mt-1">`;
            // 上一页
            html += `<button class="btn btn-light" onclick="gotoPage(${curPage - 1})">
                <i class="fa fa-chevron-left"></i> 上一页
                </button>`;
            // 跳转按钮
            html += `<button class="btn btn-light" onclick="jumpTo()">${curPage} / ${pageNum}</button>`;
            
            // 下一页
            html += `<button class="btn btn-light" onclick="gotoPage(${curPage + 1})">
                下一页 <i class="fa fa-chevron-right"></i>
                </button>`;
            html += `</div>`;
            pageNav.html(html);
        }

        let jsonPost = (url, data) => {
            return $.ajax({
                url,
                type: "POST",
                data: JSON.stringify(data),
                contentType: "application/json",
                dataType: "json"
            });
        }

        let renderTable = (data, backToFirstPage = true) => {
            curData = data;
            if (backToFirstPage) curPage = 1;
            displayTable();
        }

        let gotoPage = p => {
            if (p < 1) return;
            if (p > pageNum) return;
            curPage = p;
            displayTable();
        }

        let jumpTo = () => {
            let total = pageNum;
            let p = prompt(`请输入要跳转的页码 (1-${total})`);
            let pageInt = parseInt(p);
            if (isNaN(pageInt)) return;
            gotoPage(pageInt);
        }

        let displayTable = () => {
            let data = curData;

            if (statusFilter != "ALL") { // 启用过滤器
                if (statusFilter == "OTHER") { // 非 RUN
                    data = data.filter(item => item.status != "RUN");
                } else if (statusFilter == "4XX") { // begin with 4
                    data = data.filter(item => item.status.startsWith("4"));
                } else if (statusFilter == "5XX") { // begin with 5
                    data = data.filter(item => item.status.startsWith("5"));
                } else { // 其他
                    data = data.filter(item => item.status == statusFilter);
                }
            }

            if (tagFilter != "go") { // 启用过滤器
                data = data.filter(item => item.tag.includes(tagFilter));
            }

            data = filterCurPage(data);

            let html = '';
            for (let i = 0; i < data.length; i++) {
                let displayUrl = data[i].url.replace("https://", "");
                let idColor = "";
                let statusIcon = "";
                let status = data[i].status;
                if (status == "LOST") {
                    idColor = "warning";
                    statusIcon = `exclamation-triangle`;
                } else if (status == "WAIT") {
                    idColor = "info";
                    statusIcon = `clock-o`;
                } else if (status == "RUN") {
                    idColor = "success";
                    statusIcon = `check-circle`;
                } else {
                    idColor = "danger";
                    statusIcon = `times-circle`;
                }

                let failedReason = data[i].failedReason;
                let failedReasonHTML = "";
                if (failedReason) {
                    failedReasonHTML = ` data-toggle="tooltip" title="${failedReason}"`;
                }

                let statusHTML = ` <i class="fa fa-${statusIcon} text-${idColor}"${failedReasonHTML}></i>`;

                let tags = data[i].tag.split(",");
                let tagHTML = "";
                const tagColor = {
                    "blog": "success",
                    "normal": "secondary",
                    "coder": "info",
                    "site": "warning",
                    "life": "primary",
                    "hybrid": "danger"
                }
                for (let j = 0; j < tags.length; j++) {
                    if (tags[j] == "go") continue;
                    let thisColor = tagColor[tags[j]] || "secondary";
                    tagHTML += `<span class="badge badge-${thisColor}">${tags[j]}</span> `;
                }

                html += `
                    <tr>
                        <td data-toggle="tooltip" title="${status}">${data[i].id}</td>
                        <td>${data[i].name}${statusHTML}</td>
                        <td><a href="${data[i].url}" target="_blank">${displayUrl}</a></td>
                        <td class="pcOnly"><span${failedReasonHTML}>${data[i].status}</span></td>
                        <td class="pcOnly">${tagHTML}</td>
                        <td class="adminOnly">
                            <a href="javascript:;" onclick="editItem(${data[i].id})" data-toggle="tooltip" title="编辑"><i class="fa fa-edit"></i></a>
                            <a href="javascript:;" onclick="del(${data[i].id})" data-toggle="tooltip" title="删除"><i class="fa fa-trash"></i></a>
                        </td>
                    </tr>
                `;
            }

            if (data.length == 0) {
                html = `
                    <tr>
                        <td colspan="6" class="text-center">
                            <i class="fa fa-minus-circle"></i>
                            暂无数据
                        </td>
                    </tr>
                `;
            }

            $('#mlist').html(html);

            $('[data-toggle="tooltip"]').tooltip();

            if (userRole == "管理员") {
                $(".adminOnly").show();
            }
        }

        let search = () => {
            let kw = $('#searchInp').val().toLowerCase();
            if (kw == '') {
                renderTable(listData);
                return;
            }

            if (kw == "tlogin") {
                if (!confirm("是否前往登录页面？")) return;
                location.href = "./user/";
                return;
            }

            let dataFiltered = listData.filter(item => {
                let itemName = item.name.toLowerCase();
                let itemUrl = item.url.toLowerCase();
                let itemId = item.id;
                return itemName.includes(kw) || itemUrl.includes(kw) || itemId == kw;
            });
            
            renderTable(dataFiltered);
        }

        $('#searchInp').on('input', search);


        let initTable = async (backToFirstPage = true) => {
            let dataRaw = await $.getJSON("https://api.travellings.cn/all");
            listData = dataRaw.data;
            renderTable(listData, backToFirstPage);
        }



        let del = async (id) => {
            if (!confirm('确定要删除id为' + id + '的网站吗？')) {
                return;
            }
            let res = null;
            try {
                res = await jsonPost(`https://api.travellings.cn/action/del?token=${localStorage.tlogin}`, { id });
            } catch (error) {
                alert(error.responseJSON.msg);
                return;
            }
           
            if (res.success) {
                alert(res.msg);
                initTable();
            } else {
                alert(res.msg);
            }
        }

        let checkUser = async () => {
            let token = localStorage.tlogin;
            if (!token) return; // 未登录

            let res = await $.getJSON(`https://api.travellings.cn/user?token=${token}`);
            console.log(res);
            let data = res.data;

            let username = data.user;

            if (data.role == 0) { // 管理员
                $(".adminOnly").fadeIn();
                userRole = "管理员";
            } else if (data.role == 1) { // 普通用户
                $(".guestUserOnly").fadeIn();
            } else { // 登录失效
                localStorage.removeItem("tlogin");
                alert("您的登录态已失效，请重新登录");
                location.reload();
            }

            $(".username").text(username);          
        }


        let init = async () => {
            await initTable();
            await checkUser();
        }

        init();

        let logout = async () => {
            if (!confirm("确定要退出登录吗？")) return;

            let res = await $.getJSON(`https://api.travellings.cn/logout?token=${localStorage.tlogin}`);
            alert(res.msg);
            localStorage.removeItem("tlogin");
            
            location.reload();
        }

        $("#statusFilter").on("change", function() {
            statusFilter = $(this).val();
            renderTable(listData);
        });

        $("#tagFilter").on("change", function() {
            tagFilter = $(this).val();
            renderTable(listData);
        });

        $("#refreshBtn").on("click", async function() {
            $(this).attr("disabled", true);
            $("#refreshSpinner").show();
            await initTable();
            $(this).attr("disabled", false);
            $("#refreshSpinner").hide();
        });

        // Edit
        let showInfo = msg => {
            $('#info').text(msg).slideDown();
            setTimeout(() => {
                $('#info').slideUp();
            }, 3000);
        }

        let showSpinner = () => {
            $("#submitBtn").attr("disabled", true);
            $("#spinner").show();
        }

        let hideSpinner = () => {
            $("#submitBtn").attr("disabled", false);
            $("#spinner").hide();
        }

        let getOriginalData = async id => {
            let websiteId = id;
            let res = null;
            try {
                res = await $.getJSON(`https://api.travellings.cn/action/${websiteId}?token=${localStorage.tlogin}`);
            } catch (error) {
                showInfo(error.responseJSON.msg);
                return;
            }

            if (!res.success) {
                showInfo(res.msg);
                return;
            }

            let { name, link, status, tag } = res.data;
            $('#websiteName').val(name);
            $('#websiteLink').val(link);
            $('#tag').val(tag);
            $('#status').val(status);
        }

        let update = async () => {
            let id = $('#siteID').text();
            let name = $('#websiteName').val();
            let link = $('#websiteLink').val();
            let tag = $('#tag').val();
            let status = $('#status').val();

            showSpinner();

            // 发送更新请求
            try {
                let res = await jsonPost(`https://api.travellings.cn/action/edit?token=${localStorage.tlogin}`, {id, name, link, tag, status });
                showInfo(res.msg)
                if (res.success) {
                    $('#editItem').modal('hide');
                    initTable(false);
                }
            } catch (error) {
                showInfo(error.responseJSON.msg);
            }

            hideSpinner();
        }

        $("#submitBtn").click(update);

        let editItem = async id => {
            $('#siteID').text(id);
            await getOriginalData(id);
            $('#editItem').modal('show');
        }

        // by xuanzhi33
    </script>
</body>
