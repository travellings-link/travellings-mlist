<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>成员列表 | 开往</title>
    <link href="https://unpkg.zhimg.com/bootstrap@4.4.1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="/css/style.css">
    <style>
        .adminOnly {
            display: none;
        }
        
        @media (max-width: 768px) {
            .pcOnly {
                display: none;
            }
            #mainTitle {
                font-size: 20px;
                margin-top: 6px;
            }

            .table td, .table th {
                font-size: 14px; /* 缩小字体 */
                padding: .75rem 0px; /* 缩小间距 */
            }
        }

    </style>
</head>

<body>
    <div class="container mt-4 mb-4">
        <div class="main p-3">
            <div class="row">
                <div class="col-4">
                    <h3 id="mainTitle">成员列表</h3>
                </div>
                <div class="col-8">
                    <input type="text" class="form-control" placeholder="键入 名称/链接/ID 以搜索..." id="searchInp">
                </div>
            </div>
            <div class="mt-3">
                <a class="btn btn-primary mb-2" href="https://github.com/travellings-link/travellings/issues"><i class="fa fa-plus"></i> 申请加入</a>
                <a class="btn btn-secondary mb-2" href="https://www.travellings.cn/"><i class="fa fa-home"></i> 返回官网</a>
                <a class="btn btn-dark mb-2" href="https://www.travellings.cn/go.html"><i class="fa fa-subway"></i> 开往</a>
                <a class="btn btn-success adminOnly mb-2" href="./user/admin/add.html"><i class="fa fa-plus"></i> 新增网站</a>
                <a class="btn btn-light adminOnly mb-2" href="javascript:;" onclick="logout()"><i class="fa fa-sign-out"></i> <span id="username"></span></a>
            </div>
            <table class="table mt-3">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>站点名称</th>
                        <th>站点链接</th>
                        <th class="pcOnly">状态</th>
                        <th class="pcOnly">TAG</th> 
                        <th class="adminOnly">操作</th>
                    </tr>
                </thead>
                <tbody id="mlist">
                    <tr>
                        <td><span class="spinner-border"></span></td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    <script src="https://unpkg.zhimg.com/jquery@3/dist/jquery.min.js"></script>
    <script>
        let listData = null;

        let renderTable = data => {
            let html = '';
            for (let i = 0; i < data.length; i++) {
                let displayUrl = data[i].url.replace("https://", "");
                html += `
                    <tr>
                        <td>${data[i].id}</td>
                        <td>${data[i].name}</td>
                        <td><a href="${data[i].url}" target="_blank">${displayUrl}</a></td>
                        <td class="pcOnly">${data[i].status}</td>
                        <td class="pcOnly">${data[i].tag}</td>
                        <td class="adminOnly">
                            <a href="./user/admin/edit.html?id=${data[i].id}"><i class="fa fa-edit"></i></a>
                            <a href="javascript:;" onclick="del(${data[i].id})"><i class="fa fa-trash"></i></a>
                        </td>
                    </tr>
                `;
            }
            $('#mlist').html(html);
        }

        let search = () => {
            let kw = $('#searchInp').val().toLowerCase();
            if (kw == '') {
                renderTable(listData);
                return;
            }
            let dataFiltered = listData.filter(item => {
                let itemName = item.name.toLowerCase();
                let itemUrl = item.url.toLowerCase();
                let itemId = item.id;
                return itemName.includes(kw) || itemUrl.includes(kw) || itemId == kw;
            });
            
            renderTable(dataFiltered);
        }

        $('#searchInp').on('input', search);


        let initTable = async () => {
            let dataRaw = await $.getJSON("https://api.travellings.cn/all");
            listData = dataRaw.data;
            renderTable(listData);
        }

        initTable();


        let del = async (id) => {
            if (!confirm('确定要删除id为' + id + '的网站吗？')) {
                return;
            }
            let res = await $.post("https://api.travellings.cn/action/del", {
                id
            });
            if (res.success) {
                alert(res.msg);
                initTable();
            } else {
                alert(res.msg);
            }
        }

        let checkUser = async () => {
            let res = await $.getJSON("https://api.travellings.cn/user");
            console.log(res);
            let data = res.data;
            let userRole = "访客";
            if (data.roll == 2) { // 未登录
                return;
            }

            let username = data.username;

            if (data.role == 0) { // 管理员
                $(".adminOnly").fadeIn();
                userRole = "管理员";
            }

            $("#username").text(`${username} (${userRole})`);            
        }

        checkUser();

        let logout = async () => {
            if (!confirm("确定要退出登录吗？")) return;

            let res = await $.getJSON("https://api.travellings.cn/logout");
            alert(res.msg);
            location.reload();
        }

        // by xuanzhi33
    </script>
</body>
